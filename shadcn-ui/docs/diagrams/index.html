<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Diagrams - Requirements Estimation System</title>
    <style>
        body {
            font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
            margin: 0;
            padding: 0;
            background: #f7fafc;
        }

        header {
            padding: 16px;
            background: white;
            border-bottom: 1px solid #e6e9ee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px
        }

        .container {
            max-width: 1100px;
            margin: 24px auto;
            padding: 0 16px;
        }

        .panel {
            background: white;
            border: 1px solid #e6e9ee;
            padding: 12px;
            border-radius: 8px;
        }

        .toolbar {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        select,
        button {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #cbd5e1;
            background: white;
        }

        #diagramContainer {
            margin-top: 14px;
            padding: 12px;
            min-height: 420px;
            background: #ffffff;
            border-radius: 8px;
        }

        .hint {
            font-size: 12px;
            color: #475569
        }

        .mermaid svg {
            max-width: 100%;
        }
    </style>
    <script>
        // Try to load mermaid when needed; we also keep a direct CDN script tag removed to avoid
        // synchronous load problems on some environments and to be able to provide fallback and error UI.
    </script>
</head>

<body>
    <header>
        <div style="display:flex;gap:12px;align-items:center">
            <img src="https://cdn.jsdelivr.net/gh/mermaid-js/mermaid@main/logo/mermaid.svg" alt="Mermaid" width="36"
                height="36" style="opacity:.9">
            <div>
                <div style="font-weight:600">Syntero â€” Diagrams</div>
                <div style="font-size:12px;color:#64748b">Interactive Mermaid preview for ERD & Sequence diagrams</div>
            </div>
        </div>
        <div class="toolbar">
            <label class="hint">Theme</label>
            <select id="themeSelect">
                <option value="default">Default</option>
                <option value="dark">Dark</option>
            </select>
            <label class="hint">Diagram</label>
            <select id="diagramSelect">
                <option value="erd">ERD (Entity Relationship Diagram)</option>
                <option value="quick">Sequence - QuickEstimate</option>
                <option value="save">Sequence - Save Estimation</option>
                <option value="import">Sequence - Import Requirements</option>
            </select>
            <button id="renderBtn">Render</button>
            <button id="downloadBtn">Download SVG</button>
        </div>
    </header>

    <div class="container">
        <div class="panel">
            <div id="diagramContainer" class="mermaid"></div>
        </div>
        <div style="margin-top:12px;">
            <div id="loaderStatus" style="font-size:13px;color:#475569;">Loader status: idle</div>
            <div id="loaderLog"
                style="white-space:pre-wrap;margin-top:6px;color:#334155;font-size:12px;max-height:120px;overflow:auto;background:#f8fafc;padding:8px;border-radius:6px;border:1px solid #e6eef6">
            </div>
        </div>

        <div style="margin-top:20px;display:flex;gap:14px;">
            <div style="flex:1" class="panel">
                <div style="font-weight:600;margin-bottom:8px">Source (Mermaid)</div>
                <pre id="diagramSource"
                    style="white-space:pre-wrap;word-wrap:break-word;margin:0;">Loading diagram...</pre>
            </div>
            <div style="width:300px" class="panel">
                <div style="font-weight:600;margin-bottom:8px">Instructions</div>
                <ul style="margin:0 0 0 16px;padding:0;color:#334155;font-size:13px;">
                    <li>Choose a diagram and click <strong>Render</strong>.</li>
                    <li>Switch to <strong>Dark</strong> theme (Mermaid supports config toggle).</li>
                    <li>Click <strong>Download SVG</strong> to export the current SVG.</li>
                    <li>To preview locally, open this file in the browser. If CORS prevents local file fetch, run a
                        static server (see README below).</li>
                </ul>
                <hr style="margin:10px 0;">
                <div style="font-size:12px;color:#475569">Run a quick local server:</div>
                <pre style="margin-top:8px;background:#f1f5f9;padding:8px;border-radius:6px;">npx http-server -c-1 -p 8080 docs/diagrams
# then open http://localhost:8080/index.html</pre>
            </div>
        </div>
    </div>

    <script>
        // Fallback and dynamic loader for Mermaid to avoid `mermaid is not defined` errors.
        function ensureMermaidLoaded() {
            return new Promise((resolve, reject) => {
                if (window.mermaid) {
                    log('Mermaid already present on window');
                    return resolve(window.mermaid);
                }

                const primary = 'https://cdn.jsdelivr.net/npm/mermaid@10.0.2/dist/mermaid.min.js';
                const fallback = 'https://unpkg.com/mermaid@10.0.2/dist/mermaid.min.js';
                const local = '/lib/mermaid.min.js';

                function loadScript(src) {
                    return new Promise((res, rej) => {
                        const s = document.createElement('script');
                        s.src = src;
                        s.async = true;
                        s.onload = () => res(src);
                        s.onerror = () => rej(src);
                        document.head.appendChild(s);
                    });
                }

                log('Trying primary CDN: ' + primary);
                loadScript(primary)
                    .then((src) => {
                        log('Loaded script from: ' + src);
                        resolve(window.mermaid);
                    })
                    .catch(() => {
                        log('Primary CDN failed. Trying fallback CDN: ' + fallback);
                        return loadScript(fallback);
                    })
                    .then((src) => {
                        if (src) {
                            log('Loaded script from: ' + src);
                            resolve(window.mermaid);
                        }
                    })
                    .catch(() => {
                        log('Fallback CDN failed. Trying local fallback: ' + local);
                        return loadScript(local);
                    })
                    .then((src) => {
                        if (src) {
                            log('Loaded local script from: ' + src);
                            resolve(window.mermaid);
                        }
                    })
                    .catch((last) => {
                        log('Failed to load Mermaid. Last attempt: ' + last);
                        reject(new Error('Failed to load Mermaid from CDNs and local fallback'));
                    });
            });
        }
        const diagrams = {
            erd: `%% ERD\nerDiagram\n  USERS {\n    UUID id PK\n    string email\n  }\n\n  LISTS {\n    UUID id PK\n    UUID user_id FK -> USERS.id\n    string name\n    string description\n    UUID tech_preset_id FK -> TECHNOLOGY_PRESETS.id\n    string status\n  }\n\n  REQUIREMENTS {\n    UUID id PK\n    UUID list_id FK -> LISTS.id\n    string req_id\n    string title\n    text description\n    UUID tech_preset_id FK -> TECHNOLOGY_PRESETS.id (nullable)\n    string priority\n    string state\n    jsonb labels\n  }\n\n  ESTIMATIONS {\n    UUID id PK\n    UUID requirement_id FK -> REQUIREMENTS.id\n    UUID user_id FK -> USERS.id\n    decimal total_days\n    decimal base_days\n    decimal driver_multiplier\n    integer risk_score\n    decimal contingency_percent\n    string scenario_name\n    timestamp created_at\n  }\n\n  ESTIMATION_ACTIVITIES {\n    UUID id PK\n    UUID estimation_id FK -> ESTIMATIONS.id\n    UUID activity_id FK -> ACTIVITIES.id\n    boolean is_ai_suggested\n    text notes\n  }\n\n  ESTIMATION_DRIVERS {\n    UUID id PK\n    UUID estimation_id FK -> ESTIMATIONS.id\n    UUID driver_id FK -> DRIVERS.id\n    string selected_value\n  }\n\n  ESTIMATION_RISKS {\n    UUID id PK\n    UUID estimation_id FK -> ESTIMATIONS.id\n    UUID risk_id FK -> RISKS.id\n  }\n\n  ACTIVITIES {\n    UUID id PK\n    string code\n    string name\n    text description\n    decimal base_days\n    string tech_category\n    string \"group\"\n    boolean active\n    boolean is_custom\n    UUID base_activity_id FK -> ACTIVITIES.id (self-ref)\n    UUID created_by FK -> USERS.id\n  }\n\n  DRIVERS {\n    UUID id PK\n    string code\n    string name\n    jsonb options  -- {value, label, multiplier}\n  }\n\n  RISKS {\n    UUID id PK\n    string code\n    string name\n    integer weight\n  }\n\n  TECHNOLOGY_PRESETS {\n    UUID id PK\n    string code\n    string name\n    string tech_category\n    jsonb default_driver_values\n    jsonb default_activity_codes\n    jsonb default_risks\n  }\n\n  TECHNOLOGY_PRESET_ACTIVITIES {\n    UUID id PK\n    UUID tech_preset_id FK -> TECHNOLOGY_PRESETS.id\n    UUID activity_id FK -> ACTIVITIES.id\n    integer position\n  }\n\n  USERS ||--o{ LISTS: \"owns >\"\n  LISTS ||--o{ REQUIREMENTS: \"contains >\"\n  REQUIREMENTS ||--o{ ESTIMATIONS: \"has >\"\n  ESTIMATIONS ||--o{ ESTIMATION_ACTIVITIES: \"includes >\"\n  ESTIMATION_ACTIVITIES }o--|| ACTIVITIES: \"refers to >\"\n  ESTIMATION_DRIVERS }o--|| DRIVERS: \"refers to >\"\n  ESTIMATION_RISKS }o--|| RISKS: \"refers to >\"\n  TECHNOLOGY_PRESETS ||--o{ TECHNOLOGY_PRESET_ACTIVITIES: \"has pivot >\"\n  TECHNOLOGY_PRESET_ACTIVITIES }o--|| ACTIVITIES: \"map to >\"\n  ACTIVITIES ||--o| ACTIVITIES: \"base_activity\"\n  USERS ||--o{ ACTIVITIES: \"created_by >\"\n  TECHNOLOGY_PRESETS ||--o{ LISTS: \"default for lists (optionally) >\"`,

            quick: `%% Quick Estimate Sequence\nsequenceDiagram\n  participant U as User\n  participant UI as QuickEstimate (Client)\n  participant Sup as Supabase (DB)\n  participant Net as Netlify Function (ai-suggest)\n  participant AI as OpenAI\n  participant Calc as EstimationEngine\n\n  U->>UI: opens Quick Estimate, enters description + preset\n  UI->>Sup: fetch(activities,drivers,risks) (active only)\n  Sup-->>UI: return master data (or mock data)\n  UI->>Net: POST /.netlify/functions/ai-suggest {description,preset,activities}\n  Net->>Sup: optional token verify (Supabase auth validation)\n  Net-->>AI: OpenAI structured request\n  AI-->>Net: structured JSON suggestion\n  Net->>UI: return suggestion (isValidRequirement, activityCodes, reasoning)\n  alt suggestion valid\n    UI->>Calc: calculateEstimation({activities: AI suggested, drivers: [], risks: []})\n    Calc-->>UI: calculation result\n    UI->>U: show estimate\n  else invalid or no activities\n    UI->>Calc: calculateEstimation({activities: preset.default_activity_codes})\n    Calc-->>UI: calculation result\n    UI->>U: show estimate with fallback\n  end`,

            save: `%% Save Estimation Sequence\nsequenceDiagram\n  participant U as User\n  participant UI as RequirementDetail (Client)\n  participant Sup as Supabase (DB)\n  participant DB as DB (atomic RPC)\n\n  U->>UI: Click Save Estimation (UI validates selection)\n  UI->>U: If not auth -> prompt login\n  UI->>UI: build payload {req_id, scenarioName, activities[], drivers[], risks[], totals}\n  UI->>Sup: supabase.rpc('save_estimation_atomic', payload)\n  Sup->>DB: Run RPC (transaction)\n  DB-->>Sup: success -> returns estimation_id and counts\n  Sup-->>UI: success\n  UI->>UI: show success toast\n  UI->>Sup: refetch estimation history\n  Sup-->>UI: returns history updated`,

            import: `%% Import Sequence\nsequenceDiagram\n  participant U as User\n  participant UI as ImportRequirementsDialog (Client)\n  participant Parser as XLSX Parser (client)\n  participant Sup as Supabase (DB)\n  participant Net as Netlify Function (ai-suggest)\n  participant AI as OpenAI\n\n  U->>UI: Upload file (.xlsx/.csv)\n  UI->>Parser: parseExcelFile(file)\n  Parser-->>UI: headers + rawRows + suggestedMapping\n  UI->>U: show preview + mapping UI\n  U->>UI: confirm mapping and import\n  UI->>UI: validate rows (validateRequirements)\n  UI->>Sup: query existing req_ids (duplicate check)\n  Sup-->>UI: existing req ids\n  loop per validRow\n    UI->>UI: if missing title -> call generateTitleFromDescription\n    UI->>Net: POST /.netlify/functions/ai-suggest action=generate-title\n    Net->>AI: call openai\n    AI-->>Net: return title\n    Net-->>UI: return generated title\n    UI->>Sup: supabase.from('requirements').insert(row)\n    Sup-->>UI: return inserted row\n    UI->>U: update progress\n  end\n  UI->>U: show import complete`
        };

        const srcEl = document.getElementById('diagramSource');
        const container = document.getElementById('diagramContainer');
        const statusEl = document.getElementById('loaderStatus');
        const logEl = document.getElementById('loaderLog');

        function log(message) {
            try {
                if (statusEl) statusEl.textContent = 'Loader status: ' + message;
                if (logEl) logEl.textContent = (logEl.textContent || '') + '\n' + new Date().toLocaleTimeString() + ' - ' + message;
            } catch (e) {
                // ignore
            }
            console.log('[MermaidLoader] ' + message);
        }

        async function renderDiagram(name) {
            const md = diagrams[name];
            srcEl.textContent = md;
            try {
                log('Rendering diagram: ' + name);
                const m = await ensureMermaidLoaded();
                const theme = document.getElementById('themeSelect').value === 'dark' ? 'dark' : 'default';
                m.initialize({ startOnLoad: false, theme });
                // Use the mermaidAPI render function
                const renderId = 'diagram_' + Date.now();
                // If any parse/render error occurs, catch and display it
                m.mermaidAPI.render(renderId, md, (svgCode) => {
                    container.innerHTML = svgCode;
                }, container);
            } catch (err) {
                console.error('Failed to load Mermaid or render diagram:', err);
                container.innerHTML = '<div style="padding:12px;color:#b91c1c;font-weight:600">Errore: impossibile caricare la libreria Mermaid. Verifica la connessione o esegui la pagina tramite un server locale. Vedi console per dettagli.</div>';
            }
        }

        document.getElementById('renderBtn').addEventListener('click', () => {
            const which = document.getElementById('diagramSelect').value;
            renderDiagram(which);
        });

        document.getElementById('themeSelect').addEventListener('change', () => {
            const which = document.getElementById('diagramSelect').value;
            renderDiagram(which);
        });

        // Default render ERD
        renderDiagram('erd');

        // Download button - get svg and prompt download
        document.getElementById('downloadBtn').addEventListener('click', () => {
            const svg = container.querySelector('svg');
            if (!svg) return alert('No SVG to download. Render a diagram first.');
            const svgData = new XMLSerializer().serializeToString(svg);
            const blob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'diagram.svg';
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        });
    </script>
</body>

</html>