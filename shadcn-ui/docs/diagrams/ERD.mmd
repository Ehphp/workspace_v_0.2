%% ERD.mmd - Mermaid ERD
erDiagram
  USERS {
    UUID id PK
    string email
  }

  LISTS {
    UUID id PK
    UUID user_id FK -> USERS.id
    string name
    string description
    UUID tech_preset_id FK -> TECHNOLOGY_PRESETS.id
    string status
  }

  REQUIREMENTS {
    UUID id PK
    UUID list_id FK -> LISTS.id
    string req_id
    string title
    text description
    UUID tech_preset_id FK -> TECHNOLOGY_PRESETS.id (nullable)
    string priority
    string state
    jsonb labels
  }

  ESTIMATIONS {
    UUID id PK
    UUID requirement_id FK -> REQUIREMENTS.id
    UUID user_id FK -> USERS.id
    decimal total_days
    decimal base_days
    decimal driver_multiplier
    integer risk_score
    decimal contingency_percent
    string scenario_name
    timestamp created_at
  }

  ESTIMATION_ACTIVITIES {
    UUID id PK
    UUID estimation_id FK -> ESTIMATIONS.id
    UUID activity_id FK -> ACTIVITIES.id
    boolean is_ai_suggested
    text notes
  }

  ESTIMATION_DRIVERS {
    UUID id PK
    UUID estimation_id FK -> ESTIMATIONS.id
    UUID driver_id FK -> DRIVERS.id
    string selected_value
  }

  ESTIMATION_RISKS {
    UUID id PK
    UUID estimation_id FK -> ESTIMATIONS.id
    UUID risk_id FK -> RISKS.id
  }

  ACTIVITIES {
    UUID id PK
    string code
    string name
    text description
    decimal base_days
    string tech_category
    string "group"
    boolean active
    boolean is_custom
    UUID base_activity_id FK -> ACTIVITIES.id (self-ref)
    UUID created_by FK -> USERS.id
  }

  DRIVERS {
    UUID id PK
    string code
    string name
    jsonb options  -- {value, label, multiplier}
  }

  RISKS {
    UUID id PK
    string code
    string name
    integer weight
  }

  TECHNOLOGY_PRESETS {
    UUID id PK
    string code
    string name
    string tech_category
    jsonb default_driver_values
    jsonb default_activity_codes
    jsonb default_risks
  }

  TECHNOLOGY_PRESET_ACTIVITIES {
    UUID id PK
    UUID tech_preset_id FK -> TECHNOLOGY_PRESETS.id
    UUID activity_id FK -> ACTIVITIES.id
    integer position
  }

  USERS ||--o{ LISTS: "owns >"
  LISTS ||--o{ REQUIREMENTS: "contains >"
  REQUIREMENTS ||--o{ ESTIMATIONS: "has >"
  ESTIMATIONS ||--o{ ESTIMATION_ACTIVITIES: "includes >"
  ESTIMATION_ACTIVITIES }o--|| ACTIVITIES: "refers to >"
  ESTIMATION_DRIVERS }o--|| DRIVERS: "refers to >"
  ESTIMATION_RISKS }o--|| RISKS: "refers to >"
  TECHNOLOGY_PRESETS ||--o{ TECHNOLOGY_PRESET_ACTIVITIES: "has pivot >"
  TECHNOLOGY_PRESET_ACTIVITIES }o--|| ACTIVITIES: "map to >"
  ACTIVITIES ||--o| ACTIVITIES: "base_activity"
  USERS ||--o{ ACTIVITIES: "created_by >"
  TECHNOLOGY_PRESETS ||--o{ LISTS: "default for lists (optionally) >"
