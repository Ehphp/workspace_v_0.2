%% sequences.mmd - Mermaid Sequence diagrams

%% 1) Quick Estimate
sequenceDiagram
  participant U as User
  participant UI as QuickEstimate (Client)
  participant Sup as Supabase (DB)
  participant Net as Netlify Function (ai-suggest)
  participant AI as OpenAI
  participant Calc as EstimationEngine

  U->>UI: opens Quick Estimate, enters description + preset
  UI->>Sup: fetch(activities,drivers,risks) (active only)
  Sup-->>UI: return master data (or mock data)
  UI->>Net: POST /.netlify/functions/ai-suggest {description,preset,activities}
  Net->>Sup: optional token verify (Supabase auth validation)
  Net-->>AI: OpenAI structured request
  AI-->>Net: structured JSON suggestion
  Net->>UI: return suggestion (isValidRequirement, activityCodes, reasoning)
  alt suggestion valid
    UI->>Calc: calculateEstimation({activities: AI suggested, drivers: [], risks: []})
    Calc-->>UI: calculation result
    UI->>U: show estimate
  else invalid or no activities
    UI->>Calc: calculateEstimation({activities: preset.default_activity_codes})
    Calc-->>UI: calculation result
    UI->>U: show estimate with fallback
  end


%% 2) Save Estimation
sequenceDiagram
  participant U as User
  participant UI as RequirementDetail (Client)
  participant Sup as Supabase (DB)
  participant DB as DB (atomic RPC)

  U->>UI: Click Save Estimation (UI validates selection)
  UI->>U: If not auth -> prompt login
  UI->>UI: build payload {req_id, scenarioName, activities[], drivers[], risks[], totals}
  UI->>Sup: supabase.rpc('save_estimation_atomic', payload)
  Sup->>DB: Run RPC (transaction)
  DB-->>Sup: success -> returns estimation_id and counts
  Sup-->>UI: success
  UI->>UI: show success toast
  UI->>Sup: refetch estimation history
  Sup-->>UI: returns history updated


%% 3) Import Requirements
sequenceDiagram
  participant U as User
  participant UI as ImportRequirementsDialog (Client)
  participant Parser as XLSX Parser (client)
  participant Sup as Supabase (DB)
  participant Net as Netlify Function (ai-suggest)
  participant AI as OpenAI

  U->>UI: Upload file (.xlsx/.csv)
  UI->>Parser: parseExcelFile(file)
  Parser-->>UI: headers + rawRows + suggestedMapping
  UI->>U: show preview + mapping UI
  U->>UI: confirm mapping and import
  UI->>UI: validate rows (validateRequirements)
  UI->>Sup: query existing req_ids (duplicate check)
  Sup-->>UI: existing req ids
  loop per validRow
    UI->>UI: if missing title -> call generateTitleFromDescription
    UI->>Net: POST /.netlify/functions/ai-suggest action=generate-title
    Net->>AI: call openai
    AI-->>Net: return title
    Net-->>UI: return generated title
    UI->>Sup: supabase.from('requirements').insert(row)
    Sup-->>UI: return inserted row
    UI->>U: update progress
  end
  UI->>U: show import complete
